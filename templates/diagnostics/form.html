{% extends "base.html" %}
{% block title %}Novo Diagn√≥stico - POP{% endblock %}

{% block content %}
<h2 class="text-2xl md:text-3xl font-bold mb-6 border-l-4 border-amber-500 pl-4">
  Registrar Diagn√≥stico de SU
</h2>

<form method="post" enctype="multipart/form-data" class="bg-white p-6 rounded-lg shadow-md space-y-6">
  {% csrf_token %}

  <!-- Campos principais -->
  <div class="grid md:grid-cols-2 gap-4">
    <div>
      <label class="block text-sm font-medium mb-1">T√≠tulo</label>
      <input name="title" value="{{ form.title.value|default_if_none:'' }}" required
             class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500"
             maxlength="200" placeholder="Ex.: Falha intermitente no sensor t√©rmico">
      {% for e in form.title.errors %}<p class="text-red-600 text-sm mt-1">{{ e }}</p>{% endfor %}
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">Identificador da SU (opcional)</label>
      <input name="su_identifier" value="{{ form.su_identifier.value|default_if_none:'' }}"
             class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500"
             placeholder="Ex.: SU-AC-02">
      {% for e in form.su_identifier.errors %}<p class="text-red-600 text-sm mt-1">{{ e }}</p>{% endfor %}
    </div>
  </div>

  <div class="grid md:grid-cols-2 gap-4">
    <div>
      <label class="block text-sm font-medium mb-1">Nome</label>
      <input name="user_name" value="{{ form.user_name.value|default_if_none:'' }}" required
             class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500">
      {% for e in form.user_name.errors %}<p class="text-red-600 text-sm mt-1">{{ e }}</p>{% endfor %}
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">Email</label>
      <input name="user_email" type="email" value="{{ form.user_email.value|default_if_none:'' }}" required
             class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500"
             placeholder="seu@email.com">
      {% for e in form.user_email.errors %}<p class="text-red-600 text-sm mt-1">{{ e }}</p>{% endfor %}
    </div>
  </div>

  <div class="grid md:grid-cols-2 gap-4">
    <div>
      <label class="block text-sm font-medium mb-1">Categoria</label>
      <select name="category"
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500">
        {% for val,label in form.fields.category.choices %}
          <option value="{{ val }}" {% if form.category.value == val %}selected{% endif %}>{{ label }}</option>
        {% endfor %}
      </select>
      {% for e in form.category.errors %}<p class="text-red-600 text-sm mt-1">{{ e }}</p>{% endfor %}
    </div>
  </div>

  <div>
    <label class="block text-sm font-medium mb-1">Mensagem de diagn√≥stico</label>
    <textarea name="message" rows="6" required
              class="w-full border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500"
              placeholder="Descreva o problema, sintomas, testes realizados, etc.">{{ form.message.value }}</textarea>
    {% for e in form.message.errors %}<p class="text-red-600 text-sm mt-1">{{ e }}</p>{% endfor %}
  </div>

  <!-- Upload: Imagens -->
  <section class="space-y-3">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold">Evid√™ncias ‚Äî Imagens</h3>
      <span id="images-counter" class="text-sm text-slate-500">Nenhum arquivo</span>
    </div>

    <div id="dropzone-images"
         class="relative border-2 border-dashed rounded-xl p-6 text-center transition
                hover:bg-amber-50 focus-within:ring-2 focus-within:ring-amber-500">
      <!-- Input ocupa toda a √°rea: clique/toque abre galeria/c√¢mera -->
      <input id="input-images" name="images" type="file"
             accept="image/*" multiple
             class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
             aria-label="Selecionar imagens" />

      <div class="pointer-events-none flex flex-col items-center gap-2">
        <div class="text-3xl">üñºÔ∏è</div>
        <p class="text-slate-700">
          Arraste e solte aqui ou <span class="text-amber-700 font-semibold underline">toque/clique</span> para selecionar
          imagens (JPG, PNG, WEBP).
        </p>
        <p class="text-xs text-slate-500">Dica: voc√™ pode selecionar v√°rias de uma vez.</p>
      </div>
    </div>

    <!-- Pr√©-visualiza√ß√£o (grid responsivo) -->
    <div id="images-preview" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3"></div>
  </section>

  <!-- Upload: V√≠deos -->
  <section class="space-y-3">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold">Evid√™ncias ‚Äî V√≠deos</h3>
      <span id="videos-counter" class="text-sm text-slate-500">Nenhum arquivo</span>
    </div>

    <div id="dropzone-videos"
         class="relative border-2 border-dashed rounded-xl p-6 text-center transition
                hover:bg-amber-50 focus-within:ring-2 focus-within:ring-amber-500">
      <!-- Input ocupa toda a √°rea: clique/toque abre galeria/c√¢mera -->
      <input id="input-videos" name="videos" type="file"
             accept="video/*" multiple
             class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
             aria-label="Selecionar v√≠deos" />

      <div class="pointer-events-none flex flex-col items-center gap-2">
        <div class="text-3xl">üé¨</div>
        <p class="text-slate-700">
          Arraste e solte aqui ou <span class="text-amber-700 font-semibold underline">toque/clique</span>
          para selecionar v√≠deos (m√°x. 20&nbsp;MB por arquivo).
        </p>
        <p class="text-xs text-slate-500">Faremos compress√£o autom√°tica no servidor quando poss√≠vel.</p>
      </div>
    </div>

    <!-- Lista de v√≠deos (responsiva) -->
    <ul id="videos-list" class="space-y-1 text-sm text-slate-700"></ul>
  </section>

  <div class="flex items-center gap-3 pt-2">
    <button class="px-6 py-2 bg-amber-500 text-white font-semibold rounded-lg hover:bg-amber-600 transition">
      Salvar
    </button>
    <a href="{% url 'diagnostics:list' %}" class="px-6 py-2 border rounded-lg hover:bg-slate-50">
      Voltar √† busca
    </a>
  </div>
</form>

<!-- Script de UX (drag-and-drop + preview + contadores + remover + merge selections) -->
<script>
  // Cria/atualiza FileList (FileList √© read-only)
  function setInputFiles(input, filesArray) {
    const dt = new DataTransfer();
    filesArray.forEach(f => dt.items.add(f));
    input.files = dt.files;
  }

  // Gera chave √∫nica para deduplicar
  function fileKey(f) {
    return [f.name, f.size, f.lastModified].join("|");
  }

  // Faz merge + dedup de arquivos
  function mergeFiles(existing, added) {
    const map = new Map(existing.map(f => [fileKey(f), f]));
    added.forEach(f => map.set(fileKey(f), f));
    return Array.from(map.values());
  }

  function setupDropzone({ zoneId, inputId, previewGridId=null, counterId=null, isVideo=false }) {
    const zone = document.getElementById(zoneId);
    const input = document.getElementById(inputId);
    const previewGrid = previewGridId ? document.getElementById(previewGridId) : null;
    const counter = counterId ? document.getElementById(counterId) : null;

    let filesState = [];

    // Se havia sele√ß√£o anterior (ex.: navega/volta)
    if (input.files && input.files.length) {
      filesState = Array.from(input.files);
    }

    function updateCounter() {
      if (!counter) return;
      const total = filesState.length;
      const sizeMB = (filesState.reduce((s, f) => s + f.size, 0) / (1024 * 1024)).toFixed(1);
      counter.textContent = total ? `${total} arquivo(s) ‚Äî ${sizeMB} MB` : 'Nenhum arquivo';
    }

    function removeAt(index) {
      filesState.splice(index, 1);
      setInputFiles(input, filesState);
      render();
    }

    function render() {
      updateCounter();

      if (previewGrid) previewGrid.innerHTML = '';
      if (isVideo) {
        const list = document.getElementById('videos-list');
        if (list) list.innerHTML = '';
      }

      if (!filesState.length) return;

      if (!isVideo && previewGrid) {
        filesState.forEach((file, idx) => {
          if (!file.type.startsWith('image/')) return;
          const url = URL.createObjectURL(file);

          const card = document.createElement('div');
          card.className = "relative group rounded-lg overflow-hidden border";

          const img = document.createElement('img');
          img.src = url;
          img.className = "w-full h-36 object-cover";
          img.onload = () => URL.revokeObjectURL(url);

          const removeBtn = document.createElement('button');
          removeBtn.type = "button";
          removeBtn.className = "absolute top-2 right-2 bg-white/90 text-red-600 border border-red-200 px-2 py-1 text-xs rounded shadow opacity-0 group-hover:opacity-100 transition";
          removeBtn.textContent = "Remover";
          removeBtn.addEventListener('click', (e) => {
            e.preventDefault();
            removeAt(idx);
          });

          card.appendChild(img);
          card.appendChild(removeBtn);
          previewGrid.appendChild(card);
        });
      }

      if (isVideo) {
        const list = document.getElementById('videos-list');
        if (!list) return;
        filesState.forEach((file, idx) => {
          const li = document.createElement('li');
          const size = (file.size / (1024*1024)).toFixed(1);
          li.className = "flex items-center justify-between gap-3";
          const nameSpan = document.createElement('span');
          nameSpan.textContent = `‚Ä¢ ${file.name} (${size} MB)`;
          li.appendChild(nameSpan);

          if (file.size > 20*1024*1024) {
            const warn = document.createElement('span');
            warn.className = "text-red-600 text-xs";
            warn.textContent = "excede 20MB";
            li.appendChild(warn);
          }

          const btn = document.createElement('button');
          btn.type = "button";
          btn.className = "ml-auto text-red-600 hover:text-red-700 text-sm underline";
          btn.textContent = "Remover";
          btn.addEventListener('click', (e) => {
            e.preventDefault();
            removeAt(idx);
          });

          li.appendChild(btn);
          list.appendChild(li);
        });
      }
    }

    // Drag & Drop
    ['dragenter','dragover'].forEach(ev => {
      zone.addEventListener(ev, (e) => {
        e.preventDefault(); e.stopPropagation();
        zone.classList.add('bg-amber-50');
      });
    });
    ['dragleave','drop'].forEach(ev => {
      zone.addEventListener(ev, (e) => {
        e.preventDefault(); e.stopPropagation();
        zone.classList.remove('bg-amber-50');
      });
    });

    zone.addEventListener('drop', (e) => {
      const dropped = Array.from(e.dataTransfer.files || []);
      if (!dropped.length) return;
      filesState = mergeFiles(filesState, dropped);
      setInputFiles(input, filesState);
      render();
    });

    // Mudan√ßa via seletor nativo (AGORA: MERGE, n√£o sobrescreve)
    input.addEventListener('change', () => {
      const newly = Array.from(input.files || []);
      filesState = mergeFiles(filesState, newly);
      setInputFiles(input, filesState);
      render();
    });

    // Render inicial
    render();
  }

  // Inicializa as duas dropzones
  setupDropzone({ zoneId: 'dropzone-images', inputId: 'input-images', previewGridId: 'images-preview', counterId: 'images-counter', isVideo: false });
  setupDropzone({ zoneId: 'dropzone-videos', inputId: 'input-videos', previewGridId: null, counterId: 'videos-counter', isVideo: true });
</script>
{% endblock %}
